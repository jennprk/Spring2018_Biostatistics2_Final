#Question 3 - Build a model to predict whether a patient will die in the first 180 days after hospitalization, based on all pre-treatment covariates. Comment on the interpretation of the coefficients of this model.

#Part 1

#pre-treatment covariates
fit1 <-glm(death ~ rhc + agegroup + sex + education + race + income + weight + primary_dis_cat + cancer + cardio_com + heartfailure_com + dementia_com + psychiatric_com + pulmonary_com + renal_com + Cirrhosis_com + GIbleed_com + malign_com + immune_com + transfer_com + myocardio_com + DASI + APACHEscore + glasgow + bloodPressure + wbc + heartRate + respRate + temperature + PaO2FIO2ratio + albumin + hematocrit + bilirubin + creatinine + sodium + potassium + PaCo2 + PH + DNR + medicalInsurance + respDiag + cardioDiag + neuroDiag + gastroDiag + renalDiag + metaDiag + hemaDiag + sepsisDiag + traumaDiag + orthoDiag, data=data, family="binomial")

summary(fit1)

exp(coef(summary(fit1)))

#Part 2
# marginal risk ratio
data_rhc1 <- as.data.frame(cbind(data[,-36], rhc=rep("RHC",nrow(data))))
data_rhc0 <- as.data.frame(cbind(data[,-36], rhc=rep("No RHC",nrow(data))))
data_rhc1$rhc <- as.factor(data_rhc1$rhc)
data_rhc0$rhc <- as.factor(data_rhc0$rhc)
p1 <- predict(fit1, newdata = data_rhc1, type = 'response')
p0 <- predict(fit1, newdata = data_rhc0, type="response")
rr <- mean(p1) / mean(p0)

# marginal risk ratio and ci
logit.bootstrap <- function(formula, data, indices) {
  
  d <- data[indices, ]
  fit1 <- glm(formula, data = d, family = "binomial")
  
  d1 <- as.data.frame(cbind(data[,-36], rhc=rep("RHC",nrow(data))))
  d <- as.data.frame(cbind(data[,-36], rhc=rep("No RHC",nrow(data))))
  d1$rhc <- as.factor(d1$rhc)
  d$rhc <- as.factor(d$rhc)
  
  p1 <- predict(fit1, newdata = d1, type = 'response')
  p0 <- predict(fit1, newdata = d, type="response")
  rr <- mean(p1) / mean(p0)
  return(rr)
}

results_rr <- boot(data=data,statistic=logit.bootstrap,R=100,formula=death~agegroup+sex+education+race+income+weight+primary_dis_cat+secondary_disease_cat+cancer+cardio_com+heartfailure_com+dementia_com+psychiatric_com+pulmonary_com+renal_com+Cirrhosis_com+GIbleed_com+malign_com+immune_com+transfer_com+myocardio_com+survivalProb+DASI+APACHEscore+glasgow+bloodPressure+wbc+heartRate+respRate+temperature+PaO2FIO2ratio+albumin+hematocrit+bilirubin+creatinine+sodium+potassium+PaCo2+PH+DNR+medicalInsurance+respDiag+cardioDiag+neuroDiag+gastroDiag+renalDiag+metaDiag+hemaDiag+sepsisDiag+traumaDiag+orthoDiag+rhc)

ci_rr <- confint(results_rr)

# tables
x <- c(rr, ci_rr)
colnames(x) <- c("Value", "Lower CI Bound", "Upper CI Bound")
knitr::kable(x)
