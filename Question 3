#Question 3 - Build a model to predict whether a patient will die in the first 180 days after hospitalization, based on all pre-treatment covariates. Comment on the interpretation of the coefficients of this model.

#Part 1
#pre-treatment covariates
fit1 <-glm(death ~ agegroup+sex+education+race+income+weight+primary_dis_cat+ cancer+
cardio_com+heartfailure_com+dementia_com+psychiatric_com+pulmonary_com+renal_com+Cirrhosis_com+
GIbleed_com+malign_com+immune_com+transfer_com+myocardio_com+survivalProb+DASI+APACHEscore+glasgow+
bloodPressure+wbc+heartRate+respRate+temperature+PaO2FIO2ratio+albumin+hematocrit+bilirubin+creatinine+
sodium+potassium+PaCo2+PH+DNR+medicalInsurance+respDiag+cardioDiag+neuroDiag+gastroDiag+renalDiag+metaDiag+
hemaDiag+sepsisDiag+traumaDiag+orthoDiag+rhc,data=data,family="binomial")
summary(fit1)


#Part 2
# marginal risk ratio
data_rhc1 <- as.data.frame(cbind(data[,-35], rhc=rep("RHC",nrow(data))))
data_rhc0 <- as.data.frame(cbind(data[,-35], rhc=rep("No RHC",nrow(data))))
data_rhc1$rhc <- as.factor(data_rhc1$rhc)
data_rhc0$rhc <- as.factor(data_rhc0$rhc)
p1 <- predict(fit1, newdata = data_rhc1, type = 'response')
p0 <- predict(fit1, newdata = data_rhc0, type= "response")
rr <- mean(p1) / mean(p0)

# marginal risk ratio and ci
logit.bootstrap <- function(formula, data, indices) {
  
  d <- data[indices, ]
  fit1 <- glm(formula, data = d, family = "binomial")
  
  d1 <- as.data.frame(cbind(d[,-35], rhc=rep("RHC",nrow(d))))
  d2 <- as.data.frame(cbind(d[,-35], rhc=rep("No RHC",nrow(d))))
  d1$rhc <- as.factor(d1$rhc)
  d2$rhc <- as.factor(d2$rhc)
  
  p1 <- predict(fit1, newdata = d1, type = 'response')
  p0 <- predict(fit1, newdata = d2, type="response")
  rr <- mean(p1) / mean(p0)
  return(rr)
}

library(boot)
library(car)
results_rr <- boot(data=data,statistic=logit.bootstrap,R=100,formula=death~agegroup+sex+education+race+income+weight+primary_dis_cat+cancer+cardio_com+heartfailure_com+dementia_com+psychiatric_com+pulmonary_com+renal_com+Cirrhosis_com+GIbleed_com+malign_com+immune_com+transfer_com+myocardio_com+survivalProb+DASI+APACHEscore+glasgow+bloodPressure+wbc+heartRate+respRate+temperature+PaO2FIO2ratio+albumin+hematocrit+bilirubin+creatinine+sodium+potassium+PaCo2+PH+DNR+medicalInsurance+respDiag+cardioDiag+neuroDiag+gastroDiag+renalDiag+metaDiag+hemaDiag+sepsisDiag+traumaDiag+orthoDiag+rhc)

str(data)
data$secondary_disease_cat
unique(data$secondary_disease_cat)
levels(data$secondary_disease_cat)
sum(data$secondary_disease_cat=="Cirrhosis")
ci_rr <- confint(results_rr,type="perc")

# tables
x <- cbind(rr, ci_rr)
colnames(x) <- c("Value", "Lower CI Bound", "Upper CI Bound")
knitr::kable(x)
